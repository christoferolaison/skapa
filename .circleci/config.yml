aliases:
  - &restore-cache
    keys:
      - yarn-packages-{{ checksum "yarn.lock" }}
  - &yarn-install
    name: 'Yarn install'
    command: yarn install --ignore-engines
  - &save-cache
    key: yarn-packages-{{ checksum "yarn.lock" }}
    paths:
      - ~/.cache/yarn

defaults: &defaults
  docker:
    - image: circleci/node:13.4.0

version: 2

jobs:
  node_modules:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-cache
      - run: *yarn-install
      - save_cache: *save-cache

  build:
    <<: *defaults

    steps:
      - checkout
      - restore_cache: *restore-cache

      - run: *yarn-install

      - run:
          name: Build Skapa Web
          command: yarn workspace skapa-web run now-build

      - persist_to_workspace:
          root: .
          paths:
            - web/.next

  unit_and_integration:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-cache
      - run: *yarn-install
      - run:
          name: Unit and Integration tests
          command: yarn test

lint:
  <<: *defaults
  steps:
    - checkout
    - restore_cache: *restore-cache
    - run: *yarn-install
    - run:
        name: Run Eslint
        command: yarn lint
flow:
  <<: *defaults
  steps:
    - checkout
    - restore_cache: *restore-cache
    - run: *yarn-install
    - run:
        name: Run flow
        command: yarn flow chech

packtrack:
  <<: *defaults
  steps:
    - checkout
    - restore_cache: *restore-cache
    - run: *yarn-install
    - attach_workspace:
        at: .
    - run:
        name: Upload webpack stats to packtracker
        command: yarn workspace skapa-web run packtracker-upload --stats=.next/stats.json

workflows:
  version: 2
  feature:
    jobs:
      - node_modules
      - unit_and_integration:
          requires:
            - node_modules
      - lint:
          requires:
            - node_modules
      - flow:
          requires:
            - node_modules
      - build:
          requires:
            - unit_and_integration
            - lint
            - flow
      - packtrack:
          requires:
            - build
